{"version":3,"sources":["compile.js"],"names":[],"mappings":"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","file":"compile-compiled.js","sourcesContent":["/*\n\tcompiles a selector to an executable function\n*/\n\nmodule.exports = compile;\nmodule.exports.compileUnsafe = compileUnsafe;\nmodule.exports.compileToken = compileToken;\n\nvar parse       = require(\"css-what\"),\n    DomUtils    = require(\"domutils\"),\n    isTag       = DomUtils.isTag,\n    Rules       = require(\"./general.js\"),\n    sortRules   = require(\"./sort.js\"),\n    BaseFuncs   = require(\"boolbase\"),\n    trueFunc    = BaseFuncs.trueFunc,\n    falseFunc   = BaseFuncs.falseFunc,\n    procedure   = require(\"./procedure.json\");\n\nfunction compile(selector, options, context){\n\tvar next = compileUnsafe(selector, options, context);\n\treturn wrap(next);\n}\n\nfunction wrap(next){\n\treturn function base(elem){\n\t\treturn isTag(elem) && next(elem);\n\t};\n}\n\nfunction compileUnsafe(selector, options, context){\n\tvar token = parse(selector, options);\n\treturn compileToken(token, options, context);\n}\n\nfunction includesScopePseudo(t){\n    return t.type === \"pseudo\" && (\n        t.name === \"scope\" || (\n            Array.isArray(t.data) &&\n            t.data.some(function(data){\n                return data.some(includesScopePseudo);\n            })\n        )\n    );\n}\n\nvar DESCENDANT_TOKEN = {type: \"descendant\"},\n    SCOPE_TOKEN = {type: \"pseudo\", name: \"scope\"},\n    PLACEHOLDER_ELEMENT = {},\n    getParent = DomUtils.getParent;\n\n//CSS 4 Spec (Draft): 3.3.1. Absolutizing a Scope-relative Selector\n//http://www.w3.org/TR/selectors4/#absolutizing\nfunction absolutize(token, context){\n    //TODO better check if context is document\n    var hasContext = !!context && !!context.length && context.every(function(e){\n        return e === PLACEHOLDER_ELEMENT || !!getParent(e);\n    });\n\n\n    token.forEach(function(t){\n        if(t.length > 0 && isTraversal(t[0]) && t[0].type !== \"descendant\"){\n            //don't return in else branch\n        } else if(hasContext && !includesScopePseudo(t)){\n            t.unshift(DESCENDANT_TOKEN);\n        } else {\n            return;\n        }\n\n        t.unshift(SCOPE_TOKEN);\n    });\n}\n\nfunction compileToken(token, options, context){\n    token = token.filter(function(t){ return t.length > 0; });\n\n\ttoken.forEach(sortRules);\n\n\tvar isArrayContext = Array.isArray(context);\n\n    context = (options && options.context) || context;\n\n    if(context && !isArrayContext) context = [context];\n\n    absolutize(token, context);\n\n\treturn token\n\t\t.map(function(rules){ return compileRules(rules, options, context, isArrayContext); })\n\t\t.reduce(reduceRules, falseFunc);\n}\n\nfunction isTraversal(t){\n\treturn procedure[t.type] < 0;\n}\n\nfunction compileRules(rules, options, context, isArrayContext){\n\tvar acceptSelf = (isArrayContext && rules[0].name === \"scope\" && rules[1].type === \"descendant\");\n\treturn rules.reduce(function(func, rule, index){\n\t\tif(func === falseFunc) return func;\n\t\treturn Rules[rule.type](func, rule, options, context, acceptSelf && index === 1);\n\t}, options && options.rootFunc || trueFunc);\n}\n\nfunction reduceRules(a, b){\n\tif(b === falseFunc || a === trueFunc){\n\t\treturn a;\n\t}\n\tif(a === falseFunc || b === trueFunc){\n\t\treturn b;\n\t}\n\n\treturn function combine(elem){\n\t\treturn a(elem) || b(elem);\n\t};\n}\n\n//:not, :has and :matches have to compile selectors\n//doing this in lib/pseudos.js would lead to circular dependencies,\n//so we add them here\n\nvar Pseudos     = require(\"./pseudos.js\"),\n    filters     = Pseudos.filters,\n    existsOne   = DomUtils.existsOne,\n    isTag       = DomUtils.isTag,\n    getChildren = DomUtils.getChildren;\n\n\nfunction containsTraversal(t){\n\treturn t.some(isTraversal);\n}\n\nfilters.not = function(next, token, options, context){\n\tvar opts = {\n\t    \txmlMode: !!(options && options.xmlMode),\n\t    \tstrict: !!(options && options.strict)\n\t    };\n\n\tif(opts.strict){\n\t\tif(token.length > 1 || token.some(containsTraversal)){\n\t\t\tthrow new SyntaxError(\"complex selectors in :not aren't allowed in strict mode\");\n\t\t}\n\t}\n\n    var func = compileToken(token, opts, context);\n\n\tif(func === falseFunc) return next;\n\tif(func === trueFunc)  return falseFunc;\n\n\treturn function(elem){\n\t\treturn !func(elem) && next(elem);\n\t};\n};\n\nfilters.has = function(next, token, options){\n\tvar opts = {\n\t\txmlMode: !!(options && options.xmlMode),\n\t\tstrict: !!(options && options.strict)\n\t};\n\n    //FIXME: Uses an array as a pointer to the current element (side effects)\n    var context = token.some(containsTraversal) ? [PLACEHOLDER_ELEMENT] : null;\n\n\tvar func = compileToken(token, opts, context);\n\n\tif(func === falseFunc) return falseFunc;\n\tif(func === trueFunc)  return function(elem){\n\t\t\treturn getChildren(elem).some(isTag) && next(elem);\n\t\t};\n\n\tfunc = wrap(func);\n\n    if(context){\n        return function has(elem){\n\t\treturn next(elem) && (\n                (context[0] = elem), existsOne(func, getChildren(elem))\n            );\n\t};\n    }\n\n    return function has(elem){\n\t\treturn next(elem) && existsOne(func, getChildren(elem));\n\t};\n};\n\nfilters.matches = function(next, token, options, context){\n\tvar opts = {\n\t\txmlMode: !!(options && options.xmlMode),\n\t\tstrict: !!(options && options.strict),\n\t\trootFunc: next\n\t};\n\n\treturn compileToken(token, opts, context);\n};\n"]}